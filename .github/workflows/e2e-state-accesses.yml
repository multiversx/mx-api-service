name: E2E State Accesses

on:
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest

    services:
      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Tools versions
        run: |
          set -euxo pipefail
          go version
          git --version
          curl --version
          awk --version | head -n1

      - name: Install and start Redis + Sentinel
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y redis-server
          # Start Redis on 6379 (it may already be active on GitHub runners)
          sudo systemctl stop redis-server || true
          nohup redis-server --port 6379 > redis.out 2>&1 &
          # Create and start Sentinel on 26379 with master name 'mymaster'
          cat > sentinel.conf <<'EOF'
          port 26379
          daemonize no
          sentinel monitor mymaster 127.0.0.1 6379 1
          sentinel down-after-milliseconds mymaster 5000
          sentinel failover-timeout mymaster 60000
          sentinel parallel-syncs mymaster 1
          EOF
          nohup redis-server sentinel.conf --sentinel > redis-sentinel.out 2>&1 &
          # Wait for ports
          timeout=60; start=$(date +%s)
          until nc -z 127.0.0.1 6379; do now=$(date +%s); [ $((now-start)) -gt $timeout ] && exit 1 || sleep 1; done
          until nc -z 127.0.0.1 26379; do now=$(date +%s); [ $((now-start)) -gt $timeout ] && exit 1 || sleep 1; done

      - name: Start simulator and notifier
        run: |
          set -euxo pipefail
          ./src/test/scripts/setup-simulator-and-notifier.sh

          # Build and start the simulator with its local config
          pushd mx-chain-simulator-go/cmd/chainsimulator
          go build -v .
          nohup ./chainsimulator > sim.out 2>&1 &
          popd

          # Wait for notifier to be ready
          timeout=180
          start=$(date +%s)
          until [ "$(curl -s -o /dev/null -w '%{http_code}' http://localhost:8085/network/status/0)" = "200" ]; do
            now=$(date +%s)
            if [ $((now-start)) -gt $timeout ]; then
              echo "Notifier not ready on /network/status/0" >&2
              exit 1
            fi
            sleep 2
          done

      - name: Configure RabbitMQ exchange and queue
        run: |
          set -euxo pipefail

          # Wait for RabbitMQ management API
          for i in {1..60}; do
            if curl -sf -u guest:guest http://localhost:15672/api/overview >/dev/null; then break; fi
            sleep 1
          done

          # Helper to get HTTP status code without failing
          http_code() { curl -s -o /dev/null -w "%{http_code}" -u guest:guest "$1"; }

          # Ensure exchange exists (do not override if present)
          ex_code=$(http_code http://localhost:15672/api/exchanges/%2f/state_accesses)
          if [ "$ex_code" != "200" ]; then
            echo "Creating exchange 'state_accesses' (topic)"
            out=$(curl -s -u guest:guest -H "content-type: application/json" \
              -w "\n%{http_code}" \
              -X PUT http://localhost:15672/api/exchanges/%2f/state_accesses \
              -d '{"type":"topic","durable":true,"auto_delete":false,"internal":false,"arguments":{}}')
            code=$(echo "$out" | tail -n1)
            if [ "$code" != "201" ] && [ "$code" != "204" ]; then
              echo "Failed to create exchange, status: $code, body:" >&2
              echo "$out" | head -n -1 >&2
              exit 1
            fi
          else
            echo "Exchange 'state_accesses' already exists"
          fi

          # Ensure queue exists
          q_code=$(http_code http://localhost:15672/api/queues/%2f/state_accesses_test)
          if [ "$q_code" != "200" ]; then
            echo "Creating queue 'state_accesses_test'"
            out=$(curl -s -u guest:guest -H "content-type: application/json" \
              -w "\n%{http_code}" \
              -X PUT http://localhost:15672/api/queues/%2f/state_accesses_test \
              -d '{"durable":true,"auto_delete":false,"arguments":{}}')
            code=$(echo "$out" | tail -n1)
            if [ "$code" != "201" ] && [ "$code" != "204" ]; then
              echo "Failed to create queue, status: $code, body:" >&2
              echo "$out" | head -n -1 >&2
              exit 1
            fi
          else
            echo "Queue 'state_accesses_test' already exists"
          fi

          # Ensure binding exists
          out=$(curl -s -u guest:guest -H "content-type: application/json" \
            http://localhost:15672/api/bindings/%2f/e/state_accesses/q/state_accesses_test)
          if [ "${out}" = "[]" ] || [ -z "$out" ]; then
            echo "Creating binding 'state_accesses' -> 'state_accesses_test' with routing '#'"
            out=$(curl -s -u guest:guest -H "content-type: application/json" \
              -w "\n%{http_code}" \
              -X POST http://localhost:15672/api/bindings/%2f/e/state_accesses/q/state_accesses_test \
              -d '{"routing_key":"#","arguments":{}}')
            code=$(echo "$out" | tail -n1)
            if [ "$code" != "201" ] && [ "$code" != "204" ]; then
              echo "Failed to create binding, status: $code, body:" >&2
              echo "$out" | head -n -1 >&2
              exit 1
            fi
          else
            echo "Binding already exists"
          fi

      - name: Trigger block generation
        run: |
          set -euxo pipefail
          curl --request POST \
            --url http://localhost:8085/simulator/generate-blocks/10 \
            --header 'Content-Type: application/json' \
            --header 'User-Agent: insomnia/10.0.0'

      - name: Verify messages on queue
        run: |
          set -euxo pipefail
          # Poll the queue until messages are received
          for i in {1..60}; do
            body=$(curl -s -u guest:guest -H "content-type: application/json" \
              -X POST http://localhost:15672/api/queues/%2f/state_accesses_test/get \
              -d '{"count":10,"ackmode":"ack_requeue_true","encoding":"auto","truncate":50000}')
            # Non-empty array indicates at least one message
            if [ "$body" != "[]" ] && [ -n "$body" ]; then
              echo "Received messages on 'state_accesses_test' queue"
              echo "$body" | head -c 2000
              exit 0
            fi
            sleep 2
          done
          echo "No messages received on queue 'state_accesses_test'" >&2
          exit 1
